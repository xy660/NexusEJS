
#ifdef ESP32_PLATFORM
#include <Arduino.h>
#include <vector>
#include <csetjmp>
#include <string>
#include <locale>
#include <codecvt>
#include <iostream>
#include <SPIFFS.h>
#include "VM.h"
#include "GC.h"
#include "VariableValue.h"
#include "PlatformImpl.h"
#include "BuildinStdlib.h"
#include "StringConverter.h"

#include <BLEDevice.h>

#include "ESP32Driver/Esp32Driver.h"


void setup()
{

    

    ESP32_Platform_Init();

    auto scan = BLEDevice::getScan();
    scan->start(3000);
    auto res = scan->getResults();
    for(int i = 0;i < res.getCount();i++){
        Serial.printf("name=%s\n",res.getDevice(i).getName());
    }

    

    Serial.println("platform inited");

    RegisterSystemFunc(L"println", 1, [](std::vector<VariableValue> &args, VMObject *thisValue, VMWorker *currentWorker) -> VariableValue
    {
    Serial.print("print=>");
    Serial.println(wstring_to_string(args[0].ToString()).c_str());
    //wprintf(L"傻逼");
    //std::wcout << args[0].ToString() << std::endl;
    VariableValue ret;
    ret.varType = ValueType::NUM;
    ret.content.number = 114514; //测试C++系统函数返回值
    return ret; 
});

    RegisterSystemFunc(L"delay", 1, [](std::vector<VariableValue> &args, VMObject *thisValue, VMWorker *currentWorker) -> VariableValue
    {
    
    delay((uint32_t)args[0].content.number);

    return VariableValue(); 
    });
    
    RegisterSystemFunc(L"gc", 0, [](std::vector<VariableValue>& args, VMObject* thisValue, VMWorker* currentWorker) -> VariableValue {
    
    VariableValue ret;
    Serial.printf("memory:%.1f %\n",(1.0-(float)ESP.getFreeHeap()/ESP.getHeapSize())*100);
    currentWorker->VMInstance->currentGC->GC_Collect();
    Serial.printf("finished\n");

    ret.varType = ValueType::BOOL;
    ret.content.boolean = true; //测试C++系统函数返回值
    return ret;
    });

    Serial.println("system func init");

    GC gc;
    VM vm(&gc);

    //ESP32Driver_Init(&vm);
    ESP32Driver_Init(&vm);

    //uint8_t packed[] = {120,121,120,121,46,0,0,0,5,0,0,0,83,0,101,0,114,0,118,0,111,0,6,0,0,0,99,0,114,0,101,0,97,0,116,0,101,0,3,0,0,0,112,0,119,0,109,0,4,0,0,0,71,0,112,0,105,0,111,0,11,0,0,0,112,0,119,0,109,0,67,0,104,0,97,0,110,0,110,0,101,0,108,0,115,0,3,0,0,0,103,0,101,0,116,0,7,0,0,0,99,0,104,0,97,0,110,0,110,0,101,0,108,0,9,0,0,0,102,0,114,0,101,0,113,0,117,0,101,0,110,0,99,0,121,0,10,0,0,0,114,0,101,0,115,0,111,0,108,0,117,0,116,0,105,0,111,0,110,0,6,0,0,0,97,0,116,0,116,0,97,0,99,0,104,0,3,0,0,0,112,0,105,0,110,0,8,0,0,0,115,0,101,0,116,0,65,0,110,0,103,0,108,0,101,0,4,0,0,0,100,0,117,0,116,0,121,0,5,0,0,0,97,0,110,0,103,0,108,0,101,0,4,0,0,0,116,0,104,0,105,0,115,0,7,0,0,0,115,0,101,0,116,0,68,0,117,0,116,0,121,0,16,0,0,0,97,0,110,0,111,0,110,0,48,0,50,0,55,0,69,0,50,0,50,0,67,0,69,0,49,0,48,0,48,0,55,0,16,0,0,0,97,0,110,0,111,0,110,0,48,0,50,0,55,0,67,0,54,0,49,0,50,0,69,0,51,0,57,0,54,0,50,0,3,0,0,0,98,0,117,0,102,0,6,0,0,0,66,0,117,0,102,0,102,0,101,0,114,0,6,0,0,0,103,0,108,0,111,0,98,0,97,0,108,0,5,0,0,0,115,0,101,0,114,0,118,0,111,0,11,0,0,0,115,0,101,0,114,0,118,0,111,0,68,0,101,0,103,0,114,0,101,0,101,0,5,0,0,0,100,0,101,0,108,0,97,0,121,0,7,0,0,0,114,0,117,0,110,0,84,0,97,0,115,0,107,0,3,0,0,0,99,0,117,0,114,0,16,0,0,0,97,0,110,0,111,0,110,0,48,0,50,0,55,0,69,0,55,0,69,0,68,0,52,0,49,0,57,0,52,0,53,0,4,0,0,0,87,0,105,0,70,0,105,0,7,0,0,0,99,0,111,0,110,0,110,0,101,0,99,0,116,0,13,0,0,0,49,0,49,0,52,0,53,0,49,0,52,0,49,0,57,0,49,0,57,0,56,0,49,0,48,0,6,0,0,0,187,80,60,144,119,0,105,0,102,0,105,0,11,0,0,0,105,0,115,0,67,0,111,0,110,0,110,0,101,0,99,0,116,0,101,0,100,0,7,0,0,0,112,0,114,0,105,0,110,0,116,0,108,0,110,0,9,0,0,0,109,0,121,0,32,0,105,0,112,0,32,0,105,0,115,0,32,0,7,0,0,0,108,0,111,0,99,0,97,0,108,0,73,0,80,0,6,0,0,0,83,0,111,0,99,0,107,0,101,0,116,0,10,0,0,0,99,0,111,0,110,0,110,0,101,0,99,0,116,0,105,0,111,0,110,0,10,0,0,0,99,0,111,0,110,0,110,0,101,0,99,0,116,0,84,0,67,0,80,0,13,0,0,0,49,0,57,0,50,0,46,0,49,0,54,0,56,0,46,0,49,0,51,0,55,0,46,0,49,0,3,0,0,0,101,0,120,0,61,0,2,0,0,0,101,0,120,0,2,0,0,0,103,0,99,0,8,0,0,0,114,0,101,0,99,0,118,0,83,0,105,0,122,0,101,0,3,0,0,0,116,0,109,0,112,0,8,0,0,0,114,0,101,0,97,0,100,0,85,0,73,0,110,0,116,0,7,0,0,0,116,0,97,0,114,0,103,0,101,0,116,0,61,0,16,0,97,0,110,0,111,0,110,0,48,0,50,0,55,0,69,0,50,0,50,0,67,0,69,0,49,0,48,0,48,0,55,0,1,5,0,97,0,110,0,103,0,108,0,101,0,89,0,0,0,21,83,0,0,0,0,27,12,0,42,27,12,0,45,25,0,0,0,0,0,0,58,64,27,13,0,45,25,0,0,0,0,0,248,143,64,2,25,0,0,0,0,0,0,0,64,2,25,0,0,0,0,0,128,102,64,25,0,0,0,0,0,0,52,64,2,3,0,40,24,27,14,0,45,27,2,0,46,27,15,0,46,27,12,0,45,33,1,24,16,0,97,0,110,0,111,0,110,0,48,0,50,0,55,0,67,0,54,0,49,0,50,0,69,0,51,0,57,0,54,0,50,0,2,3,0,112,0,105,0,110,0,7,0,99,0,104,0,97,0,110,0,110,0,101,0,108,0,111,0,0,0,21,105,0,0,0,0,27,2,0,42,27,2,0,45,27,3,0,45,27,4,0,46,27,5,0,46,27,6,0,45,33,1,40,24,27,2,0,45,27,7,0,46,25,0,0,0,0,0,0,73,64,40,24,27,2,0,45,27,8,0,46,25,0,0,0,0,0,0,36,64,40,24,27,2,0,45,27,9,0,46,27,10,0,45,33,1,24,38,30,30,27,2,0,46,27,2,0,45,40,24,27,11,0,46,27,16,0,45,40,24,34,16,0,97,0,110,0,111,0,110,0,48,0,50,0,55,0,69,0,55,0,69,0,68,0,52,0,49,0,57,0,52,0,53,0,1,5,0,112,0,97,0,114,0,97,0,109,0,165,0,0,0,21,159,0,0,0,0,27,25,0,42,27,25,0,45,25,0,0,0,0,0,0,0,0,40,24,21,134,0,0,0,1,28,1,32,127,0,0,0,27,25,0,45,27,20,0,45,27,22,0,46,17,32,28,0,0,0,21,17,0,0,0,0,27,25,0,45,30,25,0,0,0,0,0,0,224,63,0,40,24,31,41,0,0,0,27,25,0,45,27,20,0,45,27,22,0,46,18,32,23,0,0,0,21,17,0,0,0,0,27,25,0,45,30,25,0,0,0,0,0,0,224,63,1,40,24,27,20,0,45,27,21,0,46,27,11,0,46,27,25,0,45,33,1,24,27,23,0,45,25,0,0,0,0,0,0,36,64,33,1,24,31,122,255,255,255,10,0,109,0,97,0,105,0,110,0,95,0,101,0,110,0,116,0,114,0,121,0,0,220,1,0,0,21,214,1,0,0,0,27,0,0,42,27,0,0,45,38,30,27,1,0,46,27,17,0,45,40,24,40,24,27,18,0,42,27,18,0,45,27,19,0,45,27,1,0,46,25,0,0,0,0,0,0,16,64,33,1,40,24,27,20,0,45,27,21,0,46,27,0,0,45,27,1,0,46,25,0,0,0,0,0,0,8,64,25,0,0,0,0,0,0,48,64,33,2,40,24,27,20,0,45,27,22,0,46,25,0,0,0,0,0,0,0,0,40,24,27,23,0,45,25,0,0,0,0,0,64,143,64,33,1,24,27,24,0,45,29,27,26,0,45,33,2,24,27,27,0,45,27,28,0,46,27,29,0,27,30,0,33,2,24,21,37,0,0,0,1,27,27,0,45,27,31,0,46,33,0,5,32,21,0,0,0,27,23,0,45,25,0,0,0,0,0,64,127,64,33,1,24,31,219,255,255,255,27,32,0,45,27,33,0,27,27,0,45,27,34,0,46,33,0,0,33,1,24,27,32,0,45,27,35,0,45,33,1,24,27,36,0,42,27,36,0,45,29,40,24,21,111,0,0,0,1,28,1,32,104,0,0,0,35,40,0,0,0,21,29,0,0,0,0,27,36,0,45,27,35,0,45,27,37,0,46,25,0,0,0,0,0,144,191,64,27,38,0,33,2,40,24,22,31,31,0,0,0,21,25,0,0,0,0,41,40,0,24,21,15,0,0,0,0,27,32,0,45,27,39,0,27,40,0,45,0,33,1,24,27,23,0,45,25,0,0,0,0,0,64,143,64,33,1,24,27,41,0,45,33,0,24,31,145,255,255,255,21,108,0,0,0,1,28,1,32,101,0,0,0,27,36,0,45,27,42,0,46,25,0,0,0,0,0,0,16,64,25,0,0,0,0,0,0,0,0,27,18,0,45,33,3,24,27,43,0,42,27,43,0,45,27,18,0,45,27,44,0,46,25,0,0,0,0,0,0,16,64,25,0,0,0,0,0,0,0,0,33,2,40,24,27,22,0,45,27,43,0,45,40,24,27,32,0,45,27,45,0,27,22,0,45,0,33,1,24,31,148,255,255,255};
    
    printf("FS.begin:%d\n",SPIFFS.begin(true));
    fs::File entry = SPIFFS.open("/entry.nejs");
    printf("size=%d\n",entry.size());
    
    uint8_t* entryNejs = (uint8_t*)platform.MemoryAlloc(entry.size());
    entry.readBytes((char*)entryNejs,entry.size());

    uint16_t packageId = vm.LoadPackedProgram(entryNejs,entry.size());
    Serial.println("loading success! calling entry..");

    std::wstring name = L"main_entry";
    uint32_t start = millis();
    auto ret = vm.InitAndCallEntry(name,packageId);

    Serial.printf("time => %d\n",millis() - start);
    Serial.print("return => ");
    Serial.printf("%s\n",wstring_to_string(ret.ToString()).c_str());

    while(true);
}

void connect()
{
}

void loop()
{
}
#endif