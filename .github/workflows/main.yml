name: NexusEJS Publish 

on:
  workflow_dispatch:
    inputs:
      version:
        description: '发布版本号'
        required: true

jobs:

  build-tools-linux:
    name: 构建工具链 (Linux)
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: 设置 .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
        
    - name: 编译所有项目
      run: |
        cd src/NexusEJS-Toolchain
        dotnet build --configuration Release
        
    - name: 发布为单文件 (Linux)
      run: |
        cd src/NexusEJS-Toolchain
        
        # 发布三个工具
        dotnet publish NexusEJSCompiler/nejsc.csproj -c Release -r linux-x64
        dotnet publish nejsdbg/nejsdbg.csproj -c Release -r linux-x64
        dotnet publish offset2line/offset2line.csproj -c Release -r linux-x64
        
    - name: 创建 Linux 工具链包
      run: |
        cd src/NexusEJS-Toolchain
        mkdir -p tools-linux
        cp NexusEJSCompiler/bin/Release/net8.0/linux-x64/publish/nejsc tools-linux/
        cp nejsdbg/bin/Release/net8.0/linux-x64/publish/nejsdbg tools-linux/
        cp offset2line/bin/Release/net8.0/linux-x64/publish/offset2line tools-linux/
        chmod +x tools-linux/*
        
    - name: 上传 Linux 工具链
      uses: actions/upload-artifact@v4
      with:
        name: tools-linux
        path: src/NexusEJS-Toolchain/tools-linux/

  build-tools-windows:
    name: 构建工具链 (Windows)
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: 设置 .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
        
    - name: 编译所有项目
      run: |
        cd src/NexusEJS-Toolchain
        dotnet build --configuration Release
        
    - name: 发布为单文件 (Windows)
      run: |
        cd src/NexusEJS-Toolchain
        
        # 发布三个工具
        dotnet publish NexusEJSCompiler/nejsc.csproj -c Release -r win-x64
        dotnet publish nejsdbg/nejsdbg.csproj -c Release -r win-x64
        dotnet publish offset2line/offset2line.csproj -c Release -r win-x64
        
    - name: 创建 Windows 工具链包
      run: |
        cd src/NexusEJS-Toolchain
        mkdir tools-windows
        copy NexusEJSCompiler\bin\Release\net8.0\win-x64\publish\nejsc.exe tools-windows\
        copy nejsdbg\bin\Release\net8.0\win-x64\publish\nejsdbg.exe tools-windows\
        copy offset2line\bin\Release\net8.0\win-x64\publish\offset2line.exe tools-windows\
        
    - name: 上传 Windows 工具链
      uses: actions/upload-artifact@v4
      with:
        name: tools-windows
        path: src/NexusEJS-Toolchain/tools-windows/


  build-firmware:
    name: 构建固件
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: 安装 PlatformIO
      run: pip install platformio
      
    - name: 编译所有固件
      run: |
        cd src/NexusEJS-Firmware
        pio run
        
    - name: 递归查找并复制固件
      run: |
        cd src/NexusEJS-Firmware
        mkdir -p firmware-output
        
        echo "=== 查找所有固件文件 ==="
        
        # 使用数组保存找到的文件
        declare -a found_files
        while IFS= read -r -d $'\0' file; do
          found_files+=("$file")
        done < <(find . -name "firmware.bin" -type f -print0)
        
        echo "找到 ${#found_files[@]} 个固件文件"
        
        # 处理每个文件
        for file in "${found_files[@]}"; do
          echo "处理: $file"
          
          # 提取环境名（父目录名）
          dir_path=$(dirname "$file")
          env_name=$(basename "$dir_path")
          
          # 生成新文件名
          new_name="nexusEJS-$env_name.bin"
          
          echo "  环境: $env_name"
          echo "  新文件名: $new_name"
          
          # 复制文件
          cp "$file" "firmware-output/$new_name"
        done
        
        echo "=== 生成的固件 ==="
        ls -la firmware-output/
        
    - name: 上传固件
      uses: actions/upload-artifact@v4
      with:
        name: firmware
        path: src/NexusEJS-Firmware/firmware-output/
        
