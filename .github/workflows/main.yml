name: NexusEJS Publish 

on:
  workflow_dispatch:
    inputs:
      version:
        description: '发布版本号'
        required: true

jobs:

  build-firmware:
    name: 构建固件
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: 安装 PlatformIO
      run: pip install platformio
      
    - name: 编译所有固件
      run: |
        cd src/NexusEJS-Firmware
        pio run
        
    - name: 递归查找并复制固件
      run: |
        cd src/NexusEJS-Firmware
        mkdir -p firmware-output
        
        echo "=== 查找所有固件文件 ==="
        
        # 使用数组保存找到的文件
        declare -a found_files
        while IFS= read -r -d $'\0' file; do
          found_files+=("$file")
        done < <(find . -name "firmware.bin" -type f -print0)
        
        echo "找到 ${#found_files[@]} 个固件文件"
        
        # 处理每个文件
        for file in "${found_files[@]}"; do
          echo "处理: $file"
          
          # 提取环境名（父目录名）
          dir_path=$(dirname "$file")
          env_name=$(basename "$dir_path")
          
          # 生成新文件名
          new_name="nexusEJS-$env_name.bin"
          
          echo "  环境: $env_name"
          echo "  新文件名: $new_name"
          
          # 复制文件
          cp "$file" "firmware-output/$new_name"
        done
        
        echo "=== 生成的固件 ==="
        ls -la firmware-output/
        
    - name: 上传固件
      uses: actions/upload-artifact@v4
      with:
        name: firmware
        path: src/NexusEJS-Firmware/firmware-output/
        
    - name: 上传固件
      uses: actions/upload-artifact@v4
      with:
        name: firmware
        path: src/NexusEJS-Firmware/firmware-output/
