name: NexusEJS Publish 

on:
  workflow_dispatch:
    inputs:
      version:
        description: '发布版本号'
        required: true

jobs:

  build-firmware:
    name: 构建固件
    runs-on: ubuntu-latest
    #needs: [build-tools-linux, build-tools-windows]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: 安装 PlatformIO
      run: pip install platformio
      
    - name: 编译所有固件
      run: |
        cd src/NexusEJS-Firmware
        pio run
        
    - name: 收集所有固件文件
      run: |
        cd src/NexusEJS-Firmware
        
        # 创建输出目录
        mkdir -p firmware-output
        
        # 递归查找所有 .bin 文件
        echo "=== 递归查找 .bin 文件 ==="
        find . -type f -name "*.bin" | while read file; do
          echo "找到: $file"
          # 复制到输出目录，保持相对路径结构
          rel_path="${file#./}"
          target_name="nexusEJS-$(basename "$rel_path")"
          cp "$file" "firmware-output/$target_name"
        done
        
        # 如果是 firmware.bin，尝试用目录名重命名
        cd firmware-output
        for file in *.bin; do
          if [[ "$file" == "firmware.bin" ]]; then
            # 查找这个文件的所有来源路径
            source_files=$(find ../. -name "firmware.bin" -type f)
            for src in $source_files; do
              # 提取父目录名
              dir_name=$(basename $(dirname "$src"))
              if [[ "$dir_name" =~ ^(esp32-basic|esp32-full|esp8266-basic|.*)$ ]]; then
                new_name="nexusEJS-$dir_name.bin"
                echo "重命名: $file -> $new_name"
                mv "$file" "$new_name"
                break
              fi
            done
          fi
        done
        
        echo "=== 生成的固件 ==="
        find . -type f -name "*.bin"
        
    - name: 上传固件
      uses: actions/upload-artifact@v4
      with:
        name: firmware
        path: src/NexusEJS-Firmware/firmware-output/
